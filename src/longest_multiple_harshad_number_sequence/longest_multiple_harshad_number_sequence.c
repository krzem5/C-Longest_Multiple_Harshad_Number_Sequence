#include <stdint.h>



static const uint64_t _remainder_table[121]={0,0,0x8000000000000000ull,0x5555555555555556ull,0x4000000000000000ull,0x3333333333333334ull,0x2aaaaaaaaaaaaaabull,0x2492492492492493ull,0x2000000000000000ull,0x1c71c71c71c71c72ull,0x199999999999999aull,0x1745d1745d1745d2ull,0x1555555555555556ull,0x13b13b13b13b13b2ull,0x124924924924924aull,0x1111111111111112ull,0x1000000000000000ull,0x0f0f0f0f0f0f0f10ull,0x0e38e38e38e38e39ull,0x0d79435e50d79436ull,0x0ccccccccccccccdull,0x0c30c30c30c30c31ull,0x0ba2e8ba2e8ba2e9ull,0x0b21642c8590b217ull,0x0aaaaaaaaaaaaaabull,0x0a3d70a3d70a3d71ull,0x09d89d89d89d89d9ull,0x097b425ed097b426ull,0x0924924924924925ull,0x08d3dcb08d3dcb09ull,0x0888888888888889ull,0x0842108421084211ull,0x0800000000000000ull,0x07c1f07c1f07c1f1ull,0x0787878787878788ull,0x0750750750750751ull,0x071c71c71c71c71dull,0x06eb3e45306eb3e5ull,0x06bca1af286bca1bull,0x0690690690690691ull,0x0666666666666667ull,0x063e7063e7063e71ull,0x0618618618618619ull,0x05f417d05f417d06ull,0x05d1745d1745d175ull,0x05b05b05b05b05b1ull,0x0590b21642c8590cull,0x0572620ae4c415caull,0x0555555555555556ull,0x05397829cbc14e5full,0x051eb851eb851eb9ull,0x0505050505050506ull,0x04ec4ec4ec4ec4edull,0x04d4873ecade304eull,0x04bda12f684bda13ull,0x04a7904a7904a791ull,0x0492492492492493ull,0x047dc11f7047dc12ull,0x0469ee58469ee585ull,0x0456c797dd49c342ull,0x0444444444444445ull,0x04325c53ef368eb1ull,0x0421084210842109ull,0x0410410410410411ull,0x0400000000000000ull,0x03f03f03f03f03f1ull,0x03e0f83e0f83e0f9ull,0x03d226357e16ece6ull,0x03c3c3c3c3c3c3c4ull,0x03b5cc0ed7303b5dull,0x03a83a83a83a83a9ull,0x039b0ad12073615bull,0x038e38e38e38e38full,0x0381c0e070381c0full,0x03759f22983759f3ull,0x0369d0369d0369d1ull,0x035e50d79435e50eull,0x03531dec0d4c77b1ull,0x0348348348348349ull,0x033d91d2a2067b24ull,0x0333333333333334ull,0x0329161f9add3c0dull,0x031f3831f3831f39ull,0x03159721ed7e7535ull,0x030c30c30c30c30dull,0x0303030303030304ull,0x02fa0be82fa0be83ull,0x02f149902f149903ull,0x02e8ba2e8ba2e8bbull,0x02e05c0b81702e06ull,0x02d82d82d82d82d9ull,0x02d02d02d02d02d1ull,0x02c8590b21642c86ull,0x02c0b02c0b02c0b1ull,0x02b9310572620ae5ull,0x02b1da46102b1da5ull,0x02aaaaaaaaaaaaabull,0x02a3a0fd5c5f02a4ull,0x029cbc14e5e0a730ull,0x0295fad40a57eb51ull,0x028f5c28f5c28f5dull,0x0288df0cac5b3f5eull,0x0282828282828283ull,0x027c45979c952050ull,0x0276276276276277ull,0x0270270270270271ull,0x026a439f656f1827ull,0x02647c69456217edull,0x025ed097b425ed0aull,0x02593f69b02593f7ull,0x0253c8253c8253c9ull,0x024e6a171024e6a2ull,0x024924924924924aull,0x0243f6f0243f6f03ull,0x023ee08fb823ee09ull,0x0239e0d5b450239full,0x0234f72c234f72c3ull,0x0230230230230231ull,0x022b63cbeea4e1a1ull,0x0226b90226b90227ull,0x0222222222222223ull};



static const uint32_t _division_table[121]={0,0,0x80000000,0x55555556,0x40000000,0x33333334,0x2aaaaaab,0x24924925,0x20000000,0x1c71c71d,0x1999999a,0x1745d175,0x15555556,0x13b13b14,0x12492493,0x11111112,0x10000000,0x0f0f0f10,0x0e38e38f,0x0d79435f,0x0ccccccd,0x0c30c30d,0x0ba2e8bb,0x0b21642d,0x0aaaaaab,0x0a3d70a4,0x09d89d8a,0x097b425f,0x0924924a,0x08d3dcb1,0x08888889,0x08421085,0x08000000,0x07c1f07d,0x07878788,0x07507508,0x071c71c8,0x06eb3e46,0x06bca1b0,0x06906907,0x06666667,0x063e7064,0x06186187,0x05f417d1,0x05d1745e,0x05b05b06,0x0590b217,0x0572620b,0x05555556,0x0539782a,0x051eb852,0x05050506,0x04ec4ec5,0x04d4873f,0x04bda130,0x04a7904b,0x04924925,0x047dc120,0x0469ee59,0x0456c798,0x04444445,0x04325c54,0x04210843,0x04104105,0x04000000,0x03f03f04,0x03e0f83f,0x03d22636,0x03c3c3c4,0x03b5cc0f,0x03a83a84,0x039b0ad2,0x038e38e4,0x0381c0e1,0x03759f23,0x0369d037,0x035e50d8,0x03531ded,0x03483484,0x033d91d3,0x03333334,0x03291620,0x031f3832,0x03159722,0x030c30c4,0x03030304,0x02fa0be9,0x02f14991,0x02e8ba2f,0x02e05c0c,0x02d82d83,0x02d02d03,0x02c8590c,0x02c0b02d,0x02b93106,0x02b1da47,0x02aaaaab,0x02a3a0fe,0x029cbc15,0x0295fad5,0x028f5c29,0x0288df0d,0x02828283,0x027c4598,0x02762763,0x02702703,0x026a43a0,0x02647c6a,0x025ed098,0x02593f6a,0x0253c826,0x024e6a18,0x02492493,0x0243f6f1,0x023ee090,0x0239e0d6,0x0234f72d,0x02302303,0x022b63cc,0x0226b903,0x02222223};



static inline uint8_t _calculate_sequence_length(uint32_t x){
	uint8_t out=0;
	while (1){
		uint32_t y=(x&0x0f0f0f0f)+((x>>4)&0x0f0f0f0f);
		y=(y&0x00ff00ff)+((y>>8)&0x00ff00ff);
		y=(y&0x000000ff)+((y>>16)&0x000000ff);
		if (y==1||y==x){
			out++;
			break;
		}
		uint64_t z=_remainder_table[y];
		if (x*z>=z){
			break;
		}
		x=(((uint64_t)x)*_division_table[y])>>32;
		out++;
	}
	return out;
}



uint8_t longest_multiple_harshad_number_sequence(uint32_t from,uint32_t to,uint32_t* out){
	if (from<2){
		from=2;
	}
	if (to<from){
		to=from+1;
	}
	uint8_t longest_length=0;
	uint32_t longest_start=0;
	while (from<to){
		uint8_t length=_calculate_sequence_length(from);
		if (length>longest_length){
			longest_length=length;
			longest_start=from;
		}
		from++;
	}
	if (out){
		*out=longest_start;
	}
	return longest_length;
}
